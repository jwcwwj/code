# 1.IP协议

网络层：负责地址管理与路由选择---IP协议，地址管理，路由选择。

IP协议：网络层的其他协议本质上都是IP协议。



## 1.1IP协议数据格式

IP协议长度不固定，最大长度60个字节，最小长度20个字节的报头信息。

![image-20231019211421618](C:\Users\19827\AppData\Roaming\Typora\typora-user-images\image-20231019211421618.png)

13位分片偏移：多个数据分片在对端会进行分片重组，而分片偏移就是用于表示当前分片在原始报文中的位置。（相对于起始位置的偏移量）	

13个比特位最大数字是8192，无法在64k报文中表示偏移量，因此分片偏移是以8字节为单位的。（分片主要是针对udp报文的）

8位TTL：报文生存周期。msl是最大数据段的生存周期，是不一样的，msl是以秒进行计算的，TTL表示一个数据所能经过的路由器条数。TTL当前默认是64或者128，最大是255，每经过一次路由转发就会-1，为0时，则将数据丢弃。

8位上层协议：当前数据所使用协议，用于数据分用时选择解析协议。

16位校验和：校验数据一致性。

32位源端和32位对端IP地址：描述通信两端主机。

0到40字节选项数据：保存一些路由信息。

数据：实际通信的数据。



分片：

ip占20个字节，udp占8个字节，tcp占20个字节，data不超过64k。（1k = 1024字节）

mtu是最大传输单元，在以太网默认是1500字节。

mss是最大数据段大小，mss = mtu - ip - tcp。（分片之后udp只会在第一个分片中有，在其他分片中是没有的。）



在网络通信中，数据传输的最大大小受到多个因素的限制。一般情况下，最大传输单位（Maximum Transmission Unit，MTU）是一个重要参数，它表示在一个网络链路上能够传输的最大数据单元大小。

对于以太网（Ethernet）来说，常见的MTU大小为1500字节。这意味着通过以太网传输的单个数据包最大不应超过1500字节（即1.5KB）。此外，IP协议头部的大小为20个字节，TCP协议头部的大小为至少20个字节，UDP协议头部的大小为8个字节。因此，实际有效载荷的最大大小会受到这些协议头部的影响。

在TCP协议中，还有一个窗口大小（Window Size）的概念，它表示在一个TCP连接中可以发送但未被确认的数据量。窗口大小的最大值可以影响数据流的传输效率和吞吐量。

根据以上信息，一般情况下，在网络通信中，单个数据包的最大大小应该小于MTU减去IP和TCP/UDP协议头部的大小。在以太网上，可用的有效载荷大小为约1460字节左右。因此，您提到的数据最大不超过64KB（64 * 1024字节）是合理的，但具体的有效载荷大小也受到其他因素的影响，如网络设备、协议选项等。



# 2.网络层功能

1.地址管理：

IP地址的管理是按照网络进行管理的（大的网络也是由多个小网络组成。）

IP地址组成：

网络号：是一个网络的标识，一个网络中分配的地址都拥有相同的标识，保证每个网络的网络号不同，则每个网络分配的IP地址不会冲突。

主机号：在一个网络内主机的标识。

网络号（网段）的划分：

A：高1位固定为0，7位网络号，24位主机号。

A类网络，网络号范围：0到127；每个网络拥有2的24次方个主机。

B：高2位固定为10，14位网络号，16位主机号。

B类网络，网络号范围值128.0到191.255；每个网络拥有2的16次方的主机。

C：高3位固定为110，21位网络号，8位主机号。

C类网络，网络号范围192.0.0到223.255.255；每个网络拥有256个主机。

当前划分采用CIDR；在早期基础上，使用子网掩码进行更细致的网络划分。

子网掩码：无符号4字节整数，必须由连续的二进制1组成。

1.子网掩码取反可以得到一个网络最大的主机号。

最大主机号 + 1就是子网中的主机号个数。

比如：

网络号：192.168.2	子网掩码：255.255.255.240	主机号：192.168.2.0到192.168.2.15

2.子网掩码与IP地址相与，可以得到网络号。



题目：有一个公司，申请了一个c类网络号192.58.45.0/24，公司中有四个部门，因此将这个c类网络平均划分成为四个子网，请问如何划分，每个子网 子网掩码是多少，网络号是多少，IP地址分配范围是多少？

192.58.45.0/24

答：这是一个c类网络，一个c类网络拥有256个主机号，平均划分四个子网，则每个子网拥有64个主机号，得到子网掩码是255.255.255.192，

IP地址分配范围是192.58.45.0到192.58.45.63，子网掩码是255.255.255.192，网络号是192.58.45.0。

IP地址分配范围是192.58.45.64到192.58.45.127，子网掩码是255.255.255.192，网络号是192.58.45.64。

IP地址分配范围是192.58.45.128到192.58.45.191，子网掩码是255.255.255.192，网络号是192.58.45.128。

IP地址分配范围是192.58.45.192到192.58.45.255，子网掩码是255.255.255.192，网络号是192.58.45.192。



特殊的IP地址：

0.0.0.0：可被识别为本机任意网卡IP地址，常用于服务器绑定监听地址。

255.255.255.255：全网广播地址。

127.0.0.1：每个主机上的虚拟回环网卡的地址，进行本地网络回环测试。

主机号全为0的IP地址：就是网络号，不能分配给某个主机。

主机号全为1的IP地址：UDP局域网广播地址，不能分配给某个主机。

一个网络内所能分配的主机号个数是总的个数 - 2。（减的2是主机号全为0的IP地址和主机号全为1的IP地址。）



tcp可以模拟广播，但是在物理层面是无法实现广播的。



公网与私网：外网与内网。

公网/外网：通常是我们所说的互联网。

私网/内网：一个组织所建立的内网私有网络。（无法直接与外部通信）



组建私网的好处是私网内部的主机如果想向外部通信的话源端主机的IP地址会被替换为对外的公网地址。



私网内部的主机，如果仅是私网内部通信，则没有什么特殊的。

但是如果私网内部主机想要向外通信，最终实际上使用的是私网对外的这个公网网卡进行的。

私网内的多个主机对外通信，都是用的是同一私网对外的IP地址，因此组建私网可以节省大量的公网IP地址。

主要因为不同的私网可以使用相同的私网IP地址而不冲突，因为私网内部主机对外通信时使用的是不同的对外公网IP。

组建私网的IP地址与公网中的IP地址不能重复：组建私网的IP地址是有固定地址的，这些地址不会在公网中被使用.

```
大的私网：10.*.*.*
中等私网：172.16.*.*到172.31.*.*
小的私网：192.168.*.*
```



2.路由选择

在复杂的网络环境中为每一条数据选择合适的路径进行转发。

![image-20231023230326478](C:\Users\19827\AppData\Roaming\Typora\typora-user-images\image-20231023230326478.png)

目标：目标网络号

网关：

子网掩码：

接口：连接这个网络的网卡。



# 3.traceroute命令

## 3.1安装

```shell
sudo apt install inetutils-traceroute
#或者
sudo apt install traceroute
```

traceroute命令用于追踪数据包在网络中传输的路径。当您使用traceroute命令并指定一个目标主机。



raceroute是一个用于追踪到达目标网络地址的网络工具，它通过发送数据包逐跳探测网络路径并计算往返时间来确定网络延迟和丢包情况。在执行traceroute命令时需要注意权限问题，如果当前用户没有足够的权限运行该命令可能会出现“Permission denied”等错误信息。

请在终端中以root身份运行以下命令来执行traceroute操作：

```
Copy Codesudo traceroute baidu.com
```

您也可以不使用sudo，在普通用户下执行traceroute，但是有些路由器需要权限才能被traceroute探测到，所以有些IP地址会无法被检测到。



```shell
traceroute baidu.com		#追踪百度网站
```

![image-20231017200317895](C:\Users\19827\AppData\Roaming\Typora\typora-user-images\image-20231017200317895.png)



# 4.数据链路层

负责相邻设备之间的数据传输。

以太网协议：ethernet。

协议格式：

对端mac地址（dmac）	源端mac地址（smac）	上层协议类型	网络层数据	crc检验和/数据帧尾

mac地址：物理网卡的硬件地址。

48位源端-对端mac地址：识别指定相邻设备。

mac地址：uint8_t mac[6]，网卡的物理硬件地址，出厂时设定，之前的物理网卡是不能改变的，现在的物理网卡是可以改变的。

16位数据类型：用于数据分用时上层解析协议的选择。

32位数据帧尾：校验和进行差错检验...

如何获取相邻指定设备的MAC地址：ARP协议。

ARP协议：介于网络层与链路程之间协议，通过IP地址获取MAC地址。

在局域网广播ARP请求（smac + sip + 0 +dip）（以太网帧中的对端mac地址全为1是广播地址。）

相邻设备收到arp请求后，检测目的IP地址是否与自己符合，不符合则直接丢弃，符合则组织arp应答，将自己mac地址填充进行回复。

两端都会将mac-ip的映射关系保存一段时间。（20到30分钟）

保存20到30分钟的原因：大多数的设备都是动态地址分配的，一旦这次网线断开了，下次连接上IP地址就改变了。

arp局域网欺骗攻击：伪造我是那个目标IP地址，将我的mac地址发送给源端，让源端将要发送的数据发送给我。

解决思路：设备白名单，只相信哪些mac地址。



链路层有一个很重要的信息，叫做MTU。

MTU：链路层限制的最大传输单元，以太网默认1500字节。

![image-20231024221038507](C:\Users\19827\AppData\Roaming\Typora\typora-user-images\image-20231024221038507.png)

MSS：最大数据段大小 = MTU - IP最小报头长度 - TCP最小报头长度。（MSS是TCP里面的，对于UDP来说没有MSS）

tcp：mtu = 1500，mss = 1460

udp：mtu = 1500，mss = 1472

mtu对于tcp传输的影响：

tcp传输三次握手阶段会协商mss，双方取较小的一方的mss作为最大数据段大小进行传输，每次从发送缓冲区中取出不大于mss大小的数据封装报头进行传输。

因此我们说，tcp在传输层会自动进行数据分段，因此不会在网络层进行数据分片。

mtu对于udp传输的影响：

udp可没有mss协商，只要数据段大小小于64k-28就可以传输，但是若大于mtu大小，则在网络层会进行数据分片。

而分片在对端会进行分片重组，一旦一个分片出问题整个报文都会被丢弃，导致的问题就是分片越多越容易出问题。（udp不保证可靠传输，丢弃了就没了）

因此，分片越多，传输出问题的几率就越高。

因此，使用udp传输，程序员最好在上层时就计算mss大小分包，尽量减少分片概率。

影响最大的是UDP，需要程序员在应用层做处理的。



DNS：domain name system域名系统

域名：是一个便于记忆字符串，是一个服务器的别名，访问服务器时通过解析得到服务器的IP地址进行访问。

```
记录域名信息：
linux：windos/system32/drivers/etc/hosts
windows：/etc/hosts
```

一个域名服务器支撑不了所有人的访问，因此采用分布式存储，将域名信息分散存储到世界各地。



域名的解析流程：

1.查看浏览器/系统缓存信息；

2.查看本地hosts文件；

3.请求本地域名服务器；

4.本地域名服务器向上层请求根域名服务器，有的话返回给步骤3，没有的话返回顶级域名服务器；（比如请求zhidao.baidu.com，没有的话返回顶级域名服务

器.com）（全世界根域名服务器只有13组）

5.然后去请求顶级服务器（比如.com），有的话就返回，没有的话就返回.baidu.com，再去请求.baidu.com，有的话就返回，没有的话就向下扩展，找到最下层

没有找到域名解析就失败了，找到就返回，这是一个迭代请求的过程，还有一个过程是递归的过程，逐层深入的过程。



面试题：

浏览器中输入url，回车后都发生了什么？

答：1.域名解析；2.搭建hcp客户端；3.组织http请求；4.发送请求；5.等待回复，解析http响应；6.根据content-type解析处理正文。

上面是客户端的，下面加入服务端的。

5.服务端收到请求进行解析；6.业务处理；7.组织http响应。



dns这个协议是一个应用层协议，在传输层通常使用的是udp通信，不是固定的，有的地方使用的是tcp。



icmp协议：Internet控制消息协议，是一个网络层的协议。（traceroute是通过icmp协议实现的）

作用：通常用于进行网络探测。

ping这个工具使用的就是icmp协议。



面试题：

telnet使用的23，ssh使用的22端口，ping使用的是多少端口？

答：ping没有使用端口，ping这个工具使用的是icmp协议实现的，icmp协议是网络层的协议，只有传输层的协议才涉及到端口。



NAT/NAPT：网络地址转换技术。

应用：用于组件私网，私网中的主机对外通信时，部署于网关设备上的NAT服务进行源端地址转换（建立映射关系），转换为对外地址后进行数据转发。

作用：节省大量IP地址的使用。

私网中的主机使用同一个对外公网地址上网，节省公网地址的使用。



代理服务：vpn翻墙。



nat和代理服务的区别：

nat是一个服务，部署在网关设备上，工作在网络层进行地址转换。

代理是一个应用，可以部署在任意设备上，工作在应用层。



# 5.总结

网络层：IP协议解析、地址管理、路由选择。

IP协议解析：

协议格式：

4位协议版本、4位头部长度、8位服务类型、16位数据报长度、16位分片标识、3位分片标志、13位分片偏移（以8字节为单位）、8位TTL、8位上层协议、16位校

验和、32位源端-对端IP地址、0到40字节选项数据（路由信息）。

数据分片：一个TCP/UDP报文长度大于MTU则会在网络层级进行分片，分成多个小的分片后，每个分片封装IP报头进行传输，到达对端进行分片重组。



地址管理：

IP地址组成：

网络号：一个网络的标识。

主机号：一个主机在某一个网络中的标识。

每个网络所分配的IP地址都会具有自己网络的网络号，只要每个网络的网络号不同，就可以最大可能减少IP地址冲突的可能性。

网络的划分：

A：高1位固定0，7位网络号，0到127，24位主机号。

B：高2位固定10，14位网络号，128.0到191.255，16位主机号。

C：高3位固定110，21位网络号，192.0.0到223.255.255，8位主机号。

D/E：特殊网络。

CIDR方案：在早期基础上使用子网掩码进行网络划分。

子网掩码：uint32_t，以连续的二进制1组成。

1.限制网络中的主机号个数：子网掩码取反就是最大主机号；

2.检测IP地址所属网络：子网掩码与IP地址相与得到网络号。

例子：公司中划分子网的例子。

特殊的IP地址：

0.0.0.0	255.255.255.255	127.0.0.1	主机号全为0	主机号全为1

公网/外网：就是通常所说的互联网。
私网/内网：通常是我们自己所建立的一个内部通信网络。

组建私网的好处：节省公网IP地址，私网内部的主机对外通信使用的都是对外的统一IP地址，这样的话私网内部的地址在不同的私网间可以重复。

```
组建私网的网络：
大型私网：10.*.*.*
中型私网：172.16.*.*到172.31.*.*
小型私网：192.168.*.*
```



路由选择：路由器根据每一条流经路由器的数据中的目标主机地址进行路径选择。



数据链路层：

ETH协议：6字节目标-源端mac地址，2字节的上层协议，数据，4字节帧尾。

mac地址：网卡的物理硬件地址。

ARP协议：介于网络层与数据链路层之间的协议，通过IP地址获取MAC地址。

arp欺骗攻击：伪造IP进行arp响应。	解决措施：防火墙白名单。

MTU：数据链路层限制的数据帧大小，最大传输单元。（以太网默认1500字节）

mtu对tcp的影响：tcp传输会协商mss，而mss = mtu - 40，往后通信每次都是从发送缓冲区中取出不大于mss大小的数据进行传输，基于这个操作，tcp也会被认

为在传输层会自动进行数据分段。

mtu对udp的影响：udp不会协商mss，只要数据大小小于64k-28都可以进行传输，然而这各数据大小有可能会大于mtu，因此会在网络层进行数据分片，分片了

则会在对端进行分片重组，然而一旦传输中任意一个分片出问题，整个报文会被丢弃，分片越多，出问题概率越高。

因此udp通信时，最好程序员在应用层就计算好每个分包大小，避免分片。

其他典型协议：

DNS：域名系统。

作用：对域名进行解析，通过域名获取到服务器IP地址。

域名：服务器的别名，通过比较容易记忆的字符串组成。

域名服务器等级：根-》顶级-》二级。

域名等级：顶级（使用性质，地址划分），二级。

域名解析流程：1.浏览器缓存；2本机hosts文件；3.本地域名服务器；4.根域名服务器；5.顶级域名服务器。

ICMP/ping，NAT/NAPT，代理服务。
